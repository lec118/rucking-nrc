/**
 * Ïö¥Îèô ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨
 * - GPS Ìä∏Îûô ÏßÄÎèÑ ÌëúÏãú
 * - Ïö¥Îèô ÌÜµÍ≥Ñ (Í±∞Î¶¨, ÏãúÍ∞Ñ, ÌéòÏù¥Ïä§, ÏπºÎ°úÎ¶¨, RuckScore Îì±)
 * - Ïö¥Îèô Ìö®Í≥º Î∂ÑÏÑù
 */

import { useMemo } from 'react';
import { MapContainer, TileLayer, Polyline, Marker } from 'react-leaflet';
import { Icon } from 'leaflet';
import Modal from './Modal';
import { formatHMS, toAvgPace } from '../utils/format';
import { useUserProfile } from '../context/UserProfileContext';
import { adaptWorkoutToBodyImpact } from '../../lib/adapters/bodyImpactAdapter';
import { calculateBodyImpact } from '../../lib/bodyImpact';
import { getAcwrInputs } from '../../lib/aggregateMetrics';
import { APP_CONSTANTS } from '../../lib/constants';
import 'leaflet/dist/leaflet.css';

interface WorkoutDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  workout: any;
  allWorkouts: any[];
}

// Leaflet ÎßàÏª§ ÏïÑÏù¥ÏΩò
const startIcon = new Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

const endIcon = new Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

export default function WorkoutDetailModal({ isOpen, onClose, workout, allWorkouts }: WorkoutDetailModalProps) {
  const { profile } = useUserProfile();

  // bodyImpact Í≥ÑÏÇ∞
  const bodyImpact = useMemo(() => {
    if (!workout) return null;

    try {
      const { recent7RuckScoreSum, recent28RuckScoreSum } = getAcwrInputs(allWorkouts);

      const input = adaptWorkoutToBodyImpact(
        workout,
        profile,
        recent7RuckScoreSum,
        recent28RuckScoreSum
      );

      return calculateBodyImpact(input);
    } catch (e) {
      console.error('bodyImpact Í≥ÑÏÇ∞ Ïã§Ìå®:', e);
      return null;
    }
  }, [workout, allWorkouts, profile]);

  if (!workout) return null;

  const hasRoute = workout.route && workout.route.length > 0;
  const distanceMeters = (workout.distance || 0) * 1000;
  const durationMs = (workout.duration || 0) * 60 * 1000;
  const timeHMS = formatHMS(durationMs);
  const avgPaceDisplay = toAvgPace(workout.distance || 0, durationMs);

  // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
  const workoutDate = new Date(workout.date);
  const dateStr = workoutDate.toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'long'
  });
  const timeStr = workoutDate.toLocaleTimeString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit'
  });

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={workout.title || 'Ïö¥Îèô ÏÉÅÏÑ∏'} maxWidth="900px">
      <div className="p-6 space-y-6">
        {/* ÎÇ†Ïßú Î∞è ÏãúÍ∞Ñ */}
        <div className="text-center border-b border-[#2D3A35]/30 pb-4">
          <p className="text-sm font-mono text-[#A8B5AF] mb-1">{dateStr}</p>
          <p className="text-xs font-mono text-[#6B7872]">{timeStr}</p>
        </div>

        {/* GPS Îßµ */}
        {hasRoute && typeof window !== 'undefined' && (
          <div
            className="relative rounded-sm overflow-hidden border border-[#2D3A35]/40"
            style={{ height: APP_CONSTANTS.MAP_DEFAULT_HEIGHT, minHeight: APP_CONSTANTS.MAP_MIN_HEIGHT }}
          >
            <MapContainer
              bounds={workout.route}
              className="w-full h-full"
              zoomControl={true}
              attributionControl={false}
            >
              <TileLayer
                url={APP_CONSTANTS.MAP_TILE_URL}
                className="map-dark-filter"
              />
              <Polyline
                positions={workout.route}
                pathOptions={{
                  color: '#00B46E',
                  weight: 4,
                  opacity: 0.9,
                  lineCap: 'round',
                  lineJoin: 'round',
                }}
              />
              {/* ÏãúÏûë ÎßàÏª§ */}
              <Marker position={workout.route[0]} icon={startIcon} />
              {/* Ï¢ÖÎ£å ÎßàÏª§ */}
              {workout.route.length > 1 && (
                <Marker position={workout.route[workout.route.length - 1]} icon={endIcon} />
              )}
            </MapContainer>
            <div className="absolute inset-0 pointer-events-none bg-gradient-to-b from-[#0A0E0D]/20 to-[#0A0E0D]/40"></div>
          </div>
        )}

        {!hasRoute && (
          <div className="bg-[#0A0E0D]/50 border border-[#2D3A35]/40 rounded-sm p-8 text-center">
            <div className="text-4xl mb-3" role="img" aria-label="ÏßÄÎèÑ">
              üó∫Ô∏è
            </div>
            <p className="text-sm font-mono text-[#6B7872]">GPS Í≤ΩÎ°ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>
          </div>
        )}

        {/* Ï£ºÏöî ÌÜµÍ≥Ñ */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div className="bg-[#0A0E0D]/50 border border-[#2D3A35]/40 rounded-sm p-4">
            <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
              Í±∞Î¶¨
            </p>
            <p className="text-2xl font-mono font-bold text-[#00B46E]">
              {(workout.distance || 0).toFixed(2)}
            </p>
            <p className="text-xs font-mono text-[#6B7872] mt-1">km</p>
          </div>

          <div className="bg-[#0A0E0D]/50 border border-[#2D3A35]/40 rounded-sm p-4">
            <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
              ÏãúÍ∞Ñ
            </p>
            <p className="text-2xl font-mono font-bold text-[#E5ECE8]">
              {Math.floor(workout.duration || 0)}
            </p>
            <p className="text-xs font-mono text-[#6B7872] mt-1">Î∂Ñ</p>
          </div>

          <div className="bg-[#0A0E0D]/50 border border-[#2D3A35]/40 rounded-sm p-4">
            <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
              ÌèâÍ∑† ÌéòÏù¥Ïä§
            </p>
            <p className="text-2xl font-mono font-bold text-[#FFB800]">
              {avgPaceDisplay}
            </p>
            <p className="text-xs font-mono text-[#6B7872] mt-1">/km</p>
          </div>

          {workout.loadKg && (
            <div className="bg-[#0A0E0D]/50 border border-[#2D3A35]/40 rounded-sm p-4">
              <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
                Î∞∞ÎÇ≠ Î¨¥Í≤å
              </p>
              <p className="text-2xl font-mono font-bold text-[#E5ECE8]">
                {workout.loadKg}
              </p>
              <p className="text-xs font-mono text-[#6B7872] mt-1">kg</p>
            </div>
          )}
        </div>

        {/* Ï∂îÍ∞Ä ÌÜµÍ≥Ñ */}
        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
          {workout.kcal && (
            <div className="bg-[#0A0E0D]/30 border border-[#2D3A35]/30 rounded-sm p-3">
              <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
                ÏπºÎ°úÎ¶¨
              </p>
              <p className="text-xl font-mono font-bold text-[#FFB800]">
                {workout.kcal}
              </p>
              <p className="text-xs font-mono text-[#6B7872] mt-1">kcal</p>
            </div>
          )}

          {workout.ruckScore && (
            <div className="bg-[#0A0E0D]/30 border border-[#2D3A35]/30 rounded-sm p-3">
              <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
                RuckScore
              </p>
              <p className="text-xl font-mono font-bold text-[#00B46E]">
                {workout.ruckScore}
              </p>
              <p className="text-xs font-mono text-[#6B7872] mt-1">Ï†ê</p>
            </div>
          )}

          {workout.elevation && (
            <div className="bg-[#0A0E0D]/30 border border-[#2D3A35]/30 rounded-sm p-3">
              <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
                Í≥†ÎèÑ ÏÉÅÏäπ
              </p>
              <p className="text-xl font-mono font-bold text-[#E5ECE8]">
                {workout.elevation}
              </p>
              <p className="text-xs font-mono text-[#6B7872] mt-1">m</p>
            </div>
          )}

          {hasRoute && (
            <div className="bg-[#0A0E0D]/30 border border-[#2D3A35]/30 rounded-sm p-3">
              <p className="text-xs font-mono text-[#6B7872] uppercase tracking-wider mb-1">
                GPS Ìè¨Ïù∏Ìä∏
              </p>
              <p className="text-xl font-mono font-bold text-[#00B46E]">
                {workout.route.length}
              </p>
              <p className="text-xs font-mono text-[#6B7872] mt-1">Í∞ú</p>
            </div>
          )}
        </div>

        {/* Ïö¥Îèô Ìö®Í≥º (bodyImpactÍ∞Ä ÏûàÎäî Í≤ΩÏö∞) */}
        {bodyImpact && (
          <div className="bg-[#1C2321]/50 border border-[#2D3A35]/40 rounded-sm p-4">
            <p className="text-xs font-mono text-[#A8B5AF] uppercase tracking-wider mb-3">
              Ïö¥Îèô Ìö®Í≥º
            </p>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div className="bg-[#0A0E0D]/30 rounded-sm p-3 text-center">
                <div className="text-2xl mb-1" role="img" aria-label="Ïã¨ÌèêÏßÄÍµ¨Î†•">‚ù§Ô∏è</div>
                <p className="text-xs font-mono text-[#6B7872] mb-1">Ïã¨ÌèêÏßÄÍµ¨Î†•</p>
                <p className="text-lg font-mono font-bold text-[#00B46E]">
                  {bodyImpact.rawValues.trimp}
                </p>
                <p className="text-xs font-mono text-[#6B7872]">TRIMP</p>
              </div>

              <div className="bg-[#0A0E0D]/30 rounded-sm p-3 text-center">
                <div className="text-2xl mb-1" role="img" aria-label="Í∑ºÏßÄÍµ¨Î†•">üí™</div>
                <p className="text-xs font-mono text-[#6B7872] mb-1">Í∑ºÏßÄÍµ¨Î†•</p>
                <p className="text-lg font-mono font-bold text-[#00B46E]">
                  {bodyImpact.rawValues.mechLoadKgKm}
                </p>
                <p className="text-xs font-mono text-[#6B7872]">kg¬∑km</p>
              </div>

              <div className="bg-[#0A0E0D]/30 rounded-sm p-3 text-center">
                <div className="text-2xl mb-1" role="img" aria-label="Í≥®ÏûêÍ∑π">ü¶¥</div>
                <p className="text-xs font-mono text-[#6B7872] mb-1">Í≥®ÏûêÍ∑π</p>
                <p className="text-lg font-mono font-bold text-[#00B46E]">
                  {bodyImpact.rawValues.bms.toFixed(1)}
                </p>
                <p className="text-xs font-mono text-[#6B7872]">BMS</p>
              </div>

              <div className="bg-[#0A0E0D]/30 rounded-sm p-3 text-center">
                <div className="text-2xl mb-1" role="img" aria-label="ÎåÄÏÇ¨">üî•</div>
                <p className="text-xs font-mono text-[#6B7872] mb-1">ÎåÄÏÇ¨</p>
                <p className="text-lg font-mono font-bold text-[#FFB800]">
                  {bodyImpact.rawValues.kcal}
                </p>
                <p className="text-xs font-mono text-[#6B7872]">kcal</p>
              </div>
            </div>
          </div>
        )}

        {/* Îã´Í∏∞ Î≤ÑÌäº */}
        <button
          onClick={onClose}
          className="w-full bg-[#2D3A35] hover:bg-[#3D4A45] text-[#E5ECE8] font-mono font-bold text-sm uppercase tracking-wider px-6 py-3 rounded-sm transition-colors"
        >
          Îã´Í∏∞
        </button>
      </div>
    </Modal>
  );
}
